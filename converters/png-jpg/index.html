 <!-- PNG ↔ JPG 변환기 (namespaced, responsive, full features kept) -->
 <div id="imgx">
   <style>
     #imgx{ --panel:#262626; --text:#e8eaed; --muted:#9aa0a6; --accent:#7aa2ff; --border:#3a3a3a; --guide-font-family:inherit; --guide-font-size:clamp(14px, 0.96rem, 16px); --guide-title-size:clamp(16px, 1.08rem, 18px); --guide-color:#f6f8ff; --guide-strong-color:#ffffff; color:var(--text); }
      #imgx *{ box-sizing:border-box; }
     #imgx .wrap{max-width:720px;margin:24px auto;padding:0 14px}
     #imgx .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
     #imgx .card h1{font-size:20px;margin:0;padding:16px 18px;border-bottom:1px solid var(--border)}
     #imgx .content{padding:16px 18px}
     #imgx .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
     #imgx .panel{border:1px solid var(--border);border-radius:12px;padding:12px;background:#1f1f1f}
     #imgx .drop{border:1.5px dashed var(--border);border-radius:12px;padding:16px;text-align:center;background:#202020}
     #imgx .drop.hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(122,162,255,.15) inset}
     #imgx .hint{color:var(--muted);font-size:12px}
     #imgx .thumb{border:1px solid var(--border);background:#111;border-radius:10px;display:flex;align-items:center;justify-content:center;min-height:220px;overflow:hidden}
     #imgx .thumb img{max-width:100%;max-height:360px;display:block}
     #imgx .btns{display:flex;gap:10px;flex-wrap:wrap}
     #imgx .btn{display:inline-flex;align-items:center;gap:6px;background:#2b2b2b;border:1px solid var(--border);color:#f1f3f7;padding:10px 14px;border-radius:10px;cursor:pointer;transition:background-color .2s ease, box-shadow .2s ease, transform .2s ease;}
     #imgx .btn:hover:not([disabled]){background:#353535;transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.3);}
     #imgx .btn:active:not([disabled]){transform:translateY(0);box-shadow:0 2px 6px rgba(0,0,0,.35);}
     #imgx .btn.primary{background:var(--accent);border-color:transparent;color:#0b1021;font-weight:700;}
     #imgx .btn.primary:hover:not([disabled]){background:#8bb1ff;box-shadow:0 6px 18px rgba(122,162,255,.35);}
     #imgx .btn.danger{background:#3a2323;border-color:#6e2b2b;}
     #imgx .btn.danger:hover:not([disabled]){background:#4a2d2d;border-color:#823434;}
     #imgx .btn.download{background:#5fd3ff;border-color:#2eb4f0;color:#041622;font-weight:700;box-shadow:0 4px 12px rgba(95,211,255,.26);}
     #imgx .btn.download:hover:not([disabled]){background:#79ddff;box-shadow:0 6px 18px rgba(95,211,255,.35);}
     #imgx .btn[disabled]{opacity:.5;cursor:not-allowed;box-shadow:none;transform:none;}
     #imgx .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:var(--muted)}
     #imgx .kv{display:flex;align-items:center;justify-content:space-between;gap:10px}
     #imgx .range{width:100%}
     #imgx .mono{font-family:ui-monospace,Consolas,monospace;font-size:12px;color:#cfd3da}
     #imgx .footer{padding:14px 18px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
     #imgx .guide{background:#1f1f1f;border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;font-size:var(--guide-font-size,14px);line-height:1.65;font-family:var(--guide-font-family,inherit);color:var(--guide-color,var(--text));}
     #imgx .guide *{color:var(--guide-color,var(--text));}
     #imgx .guide h2{margin:0 0 8px;font-size:var(--guide-title-size,16px);font-weight:800;color:var(--guide-strong-color,#fff);font-family:var(--guide-font-family,inherit);}
     #imgx .guide li{margin:6px 0;color:inherit}
     #imgx .guide b{color:var(--guide-strong-color,#fff);font-weight:600}
     @media (max-width:720px){
       #imgx{--guide-font-size:15px;--guide-title-size:17px}
       #imgx .grid2{grid-template-columns:1fr}
     }
   </style>

   <div class="wrap">
     <div class="card">
       <h1>PNG ↔ JPG 변환기</h1>
       <div class="content">
         <!-- 업로드 -->
         <div class="panel drop" id="x-drop" tabindex="0" role="button" aria-label="이미지 업로드 영역">
           <strong>파일을 여기에 드래그하거나 클릭해서 선택</strong>
           <div class="hint">지원: PNG, JPG · 최대 25MB (브라우저 메모리 한도 내)</div>
           <div class="btns" style="margin-top:10px">
             <label class="chip" for="x-file" id="x-label">파일 선택</label>
             <input id="x-file" type="file" accept="image/png,image/jpeg" style="display:none"/>
             <span class="chip" id="x-meta">원본: 없음</span>
             <span class="chip" id="x-fmtTag">자동</span>
           </div>
         </div>

         <!-- 포맷 & 옵션 -->
         <div class="grid2" style="margin-top:12px">
           <div class="panel">
             <div class="kv"><strong>출력 포맷</strong><span class="chip">자동</span></div>
             <div class="btns" style="margin-top:8px">
               <button id="x-toJpg" class="btn">PNG → JPG</button>
               <button id="x-toPng" class="btn">JPG → PNG</button>
               <button id="x-auto"  class="btn primary">자동 (입력 반대)</button>
             </div>
           </div>
           <div class="panel">
             <div class="kv"><strong>옵션</strong><span class="hint">JPG 품질 · 배경색</span></div>
             <div style="margin-top:6px;display:flex;flex-direction:column;gap:10px">
               <div class="kv">
                 <span>JPG 품질 <span id="x-qv" class="mono">0.92</span></span>
                 <input id="x-quality" class="range" type="range" min="0.1" max="1" value="0.92" step="0.01" />
               </div>
               <div class="kv">
                 <span>배경색 (PNG→JPG 시 투명 영역 채움)</span>
                 <input id="x-bg" type="color" value="#ffffff" style="width:120px;height:36px;border-radius:8px;border:1px solid var(--border);background:none;cursor:pointer"/>
               </div>
             </div>
           </div>
         </div>

         <!-- 미리보기 -->
         <div class="grid2" style="margin-top:12px">
           <div class="panel">
             <div class="kv" style="margin-bottom:8px"><strong>원본 미리보기</strong><span id="x-origInfo" class="hint">-</span></div>
             <div class="thumb" id="x-origThumb"><span class="hint">이미지를 업로드하세요</span></div>
           </div>
           <div class="panel">
             <div class="kv" style="margin-bottom:8px"><strong>변환 결과</strong><span id="x-outInfo" class="hint">-</span></div>
             <div class="thumb" id="x-outThumb"><span class="hint">아직 변환 전입니다</span></div>
           </div>
         </div>
       </div>

       <div class="footer">
         <div id="x-status" class="hint" style="flex:1;white-space:normal;line-height:1.4;word-break:keep-all;max-width:60%">대기 중</div>
         <div class="btns">
           <button id="x-clear" class="btn danger" disabled>지우기</button>
           <button id="x-convert" class="btn primary" disabled>변환하기</button>
           <a id="x-download" download style="display:none"><button class="btn download">다운로드</button></a>
         </div>
       </div>
     </div>

     <div class="guide">
       <h2>사용 방법</h2>
       <ol>
         <li><b>이미지 업로드:</b> PNG 또는 JPG를 업로드합니다. (권장: 최대 25MB)</li>
         <li><b>출력 포맷:</b> 자동(입력 반대) 또는 직접 PNG↔JPG를 선택합니다.</li>
         <li><b>옵션:</b> JPG로 저장 시 품질과 배경색(투명 채움)을 조정합니다.</li>
         <li><b>변환하기:</b> 변환 후 <b>다운로드</b>로 저장합니다.</li>
       </ol>
     </div>
   </div>

   <canvas id="x-canvas" style="display:none"></canvas>

   
    <script>
    ;(function(){
      const qs = (sel)=>document.querySelector('#imgx ' + sel);
      const drop = qs('#x-drop'), input = qs('#x-file'), label = qs('#x-label');
      const meta = qs('#x-meta'), fmtTag = qs('#x-fmtTag');
      const origThumb = qs('#x-origThumb'), outThumb = qs('#x-outThumb');
      const origInfo = qs('#x-origInfo'), outInfo = qs('#x-outInfo');
      const btnConvert = qs('#x-convert'), btnClear = qs('#x-clear'), aDownload = qs('#x-download');
      const toJpg = qs('#x-toJpg'), toPng = qs('#x-toPng'), autoBtn = qs('#x-auto');
      const quality = qs('#x-quality'), qv = qs('#x-qv'), bg = qs('#x-bg');
      const statusEl = qs('#x-status');
      const canvas = qs('#x-canvas');
      const ctx = canvas ? canvas.getContext('2d') : null;

      let file = null, img = null, target = 'auto';

      const fmtBytes = (b)=>{ if(!Number.isFinite(b)) return '-'; const u=['B','KB','MB','GB']; let i=0,v=b; while(v>1024&&i<u.length-1){v/=1024;i++} return v.toFixed(i?2:0)+' '+u[i]; };
      const setStatus = (t)=> statusEl.textContent = t;
      const hexToRgb = (h)=>{ const m=/^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i.exec(h); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:255,g:255,b:255}; };
      function isSupportedImage(f){
        const t=(f.type||'').toLowerCase();
        if (t==='image/png'||t==='image/jpeg'||t==='image/jpg'||t==='image/pjpeg'||t==='image/x-png') return true;
        const ext=(f.name.split('.').pop()||'').toLowerCase();
        return ext==='png'||ext==='jpg'||ext==='jpeg';
      }
      function chooseTargetAuto(){
        if(!file) return 'jpg';
        const ext=(file.name.split('.').pop()||'').toLowerCase();
        return ext==='png' ? 'jpg' : 'png';
      }
      function updateFmtTag(){
        const t=(target==='auto'? chooseTargetAuto(): target).toUpperCase();
        fmtTag.textContent='출력: '+t;
      }
      function resetOutput(){
        outThumb.innerHTML='<span class="hint">아직 변환 전입니다</span>';
        outInfo.textContent='-';
        aDownload.style.display='none'; aDownload.removeAttribute('href'); aDownload.removeAttribute('download');
      }

      // ✅ 단일 loadFile (ObjectURL 사용)
      function loadFile(f){
        if(!f) return;
        if(!isSupportedImage(f)){ alert('PNG 또는 JPG만 지원합니다.'); return; }
        file=f; resetOutput(); updateFmtTag();
        meta.textContent='원본: '+file.name+' · '+fmtBytes(file.size);
        const url = URL.createObjectURL(f);
        const im = new Image();
        im.onload = ()=>{
          img = im;
          origThumb.innerHTML = '';
          im.alt = '원본 미리보기';
          origThumb.appendChild(im);        // 새 태그 만들지 말고, 로드된 노드 그대로 붙임
          origInfo.textContent = im.naturalWidth + '×' + im.naturalHeight;
          btnConvert.disabled = false; btnClear.disabled = false;
          setStatus('이미지 로드 완료'); input.value = ''; updateFmtTag();
          // 미리보기가 그려진 다음 URL 해제 (너무 일찍 revoke하면 깨짐)
          setTimeout(()=> URL.revokeObjectURL(url), 1000);
        };
        im.onerror = ()=>{
          URL.revokeObjectURL(url);
          alert('이미지를 불러오지 못했습니다.');
          btnConvert.disabled = true;
        };
        im.src = url;
      }

      // DnD & 클릭 (옵셔널 체이닝 제거)
      ['dragenter','dragover'].forEach(function(type){
        drop.addEventListener(type, function(e){ e.preventDefault(); drop.classList.add('hover'); });
      });
      ['dragleave','drop'].forEach(function(type){
        drop.addEventListener(type, function(e){ e.preventDefault(); drop.classList.remove('hover'); });
      });
      drop.addEventListener('drop', function(e){
        var files = e.dataTransfer && e.dataTransfer.files;
        var f = files && files[0];
        if(f) loadFile(f);
      });
      label.addEventListener('click', function(e){ e.stopPropagation(); });
      drop.addEventListener('click', function(){ input.click(); });
      input.addEventListener('change', function(e){
        var files = e.target && e.target.files;
        var f = files && files[0];
        if(f) loadFile(f);
      });

      // 포맷 선택
      toJpg.onclick=function(){ target='jpg'; updateFmtTag(); };
      toPng.onclick=function(){ target='png'; updateFmtTag(); };
      autoBtn.onclick=function(){ target='auto'; updateFmtTag(); };

      // 옵션 표시
      quality.oninput=function(){ qv.textContent = Number(quality.value).toFixed(2); };

      function renderToCanvas(targetMime){
        if(!ctx||!img) return;
        const w=img.naturalWidth, h=img.naturalHeight;
        canvas.width=w; canvas.height=h;
        if(targetMime==='image/jpeg'){
          const {r,g,b}=hexToRgb(bg.value);
          ctx.save(); ctx.fillStyle=`rgb(${r},${g},${b})`; ctx.fillRect(0,0,w,h); ctx.restore();
        }else{
          ctx.clearRect(0,0,w,h);
        }
        ctx.drawImage(img,0,0,w,h);
      }
      function convert(){
        if(!img) return;
        btnConvert.disabled=true; setStatus('변환 중…');
        const autoExt=chooseTargetAuto();
        const targetMime=(target==='auto' ? (autoExt==='jpg'?'image/jpeg':'image/png') : (target==='jpg'?'image/jpeg':'image/png'));
        renderToCanvas(targetMime);
        const q=Number(quality.value);
        const dataUrl=canvas.toDataURL(targetMime, targetMime==='image/jpeg' && isFinite(q)? q : undefined);
        outThumb.innerHTML=''; const outImg=new Image(); outImg.src=dataUrl; outImg.alt='변환 미리보기'; outThumb.appendChild(outImg);
        const base64=dataUrl.split(',')[1]||''; const bytes=Math.ceil(base64.length*3/4);
        outInfo.textContent=(targetMime==='image/jpeg'?'JPG':'PNG')+' · '+fmtBytes(bytes);
        const base=(file && file.name ? file.name : 'image').replace(/\.(png|jpg|jpeg)$/i,'');
        const outName=base+(targetMime==='image/jpeg'?'.jpg':'.png');
        aDownload.href=dataUrl; aDownload.download=outName; aDownload.style.display='inline-block';
        setStatus('완료'); btnConvert.disabled=false;
      }
      btnConvert.addEventListener('click', convert);

      function clearAll(){
        file=null; img=null; target='auto';
        meta.textContent='원본: 없음';
        origThumb.innerHTML='<span class="hint">이미지를 업로드하세요</span>'; origInfo.textContent='-';
        resetOutput(); btnConvert.disabled=true; btnClear.disabled=true; setStatus('초기화 완료'); input.value=''; updateFmtTag();
      }
      btnClear.addEventListener('click', clearAll);

      setStatus('이미지를 업로드한 뒤 포맷을 선택하고 변환하세요. PNG→JPG 시 투명 영역은 선택한 배경색으로 채워집니다.');
    })();
  </script>
</div>
